---
title: Assessment of the  Flathead sole-Bering flounder Stock in the Bering Sea and Aleutian Islands
author: Maia S. Kapur
date: October 2022
format: html
toc: true
always_allow_html: true
editor: source
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
require(lubridate)
require(here)
require(dplyr)
## text values

spp = c('Flathead sole','Hippoglossoides esassodon', 'Hippoglossoides spp.', 'Bering flounder')
date_use = "2022-09-28" ## date for figures etc
date_use_long = paste0(month(date_use, label = T), " ",day(date_use),", ",year(date_use))
date_pull = "2022-10-01" ## date the final catch pull was made
date_pull_long = paste0(month(date_pull, label = T), " ",day(date_pull),", ",year(date_pull))
thisyr = lubridate::year(Sys.Date())
lastyr = thisyr-1
nextyr = thisyr+1
proj_years = nextyr:(thisyr+2)
proj_range = paste0(range(proj_years), collapse = "-")

## read tables
load(here('data',paste0(date_use,'-catches_for_proj.rdata'))) ## catchvec
cproj = round(data.frame(catchvec)); names(cproj)=c('year','catch')
surv = round(read.csv(here('data',paste0(date_use,"-ss_survey_index.csv"))))
```

# Executive Summary

"`r spp[1]`" as currently managed by the North Pacific Fishery Management Council (NPFMC) in the Bering Sea and Aleutian Islands (BSAI) represents a two-species complex consisting of true `r spp[1]` (*`r spp[2]`*) and its morphologically-similar congener Bering flounder (*`r spp[3]`*). In 2012, the BSAI Groundfish Plan Team moved `r spp[1]` to a biennial stock assessment schedule because it has historically been lightly exploited. A full stock assessment report was most recently produced in 2020 (Monnahan and Haehn, 2020). This year, a partial assessment is presented. In partial assessment years, an executive summary is presented to recommend harvest levels for the next two years, along with trends in catch and biomass.

`r spp[1]` is assessed using an age-structured model and Tier 3 determination. The single species projection model is run using parameter values from the accepted 2019 assessment model, together with updated catch information for `r paste0(range(2019, lastyr),collapse ="-")` and estimated catches for `r thisyr` and `r proj_range` (Figure 1), to predict stock status for `r spp[1]` in 2022 and 2023 and make ABC recommendations for those years (Table 1).

## Summary of Changes in Assessment Inputs

This assessment used a single survey index of "total" Hippoglossoides spp. biomass that included the EBS "standard" survey areas and AI survey areas for the years 1982-`r thisyr` (Table 2). As was done in the 2020 full assessment (Monnohan et. al. 2020) and the 2021 partial assessment (Kapur 2021), a linear regression is used to estimate a relationship between EBS shelf `r spp[3]` survey biomass estimates and AI survey biomass estimates; this relationship is used to estimate AI survey biomass in years when no AI survey occurred (by using the linear equation to find an AI biomass estimate in a particular year based on the EBS biomass estimate for that year). There was no AI survey conducted in `r thisyr` and AI biomass was estimated with the linear equation. The `r thisyr` total BSAI estimate was `r format(last(surv$obs), big.mark = ",")` t, a roughly `r round((last(surv$obs)-surv$obs[surv$year == 2021])/surv$obs[surv$year == 2021]*100,0)`\% increase over the `r lastyr` estimate of `r format(surv$obs[surv$year == 2021], big.mark = ",")` t (Figure 2).

To run the projection model to predict ABCs for `r proj_years[1]` and `r proj_years[2]`, estimates are required for the total catches in `r thisyr`-`r proj_years[2]`. The final catch for `r thisyr` (`r format(cproj$catch[cproj$year == thisyr], big.mark = ",")` t) was estimated by adding the average catch between `r paste0(month(date_pull, label = T), " ",day(date_pull))` and December 31 over the years `r thisyr-5`-`r lastyr` to the `r thisyr` catch as of `r date_pull_long`. The `r nextyr` and `r proj_years[2]` catches (`r format(cproj$catch[cproj$year == nextyr], big.mark = ",")` t) were estimated as the average catch over the previous 5 years (`r thisyr-5`-`r lastyr`).

To ensure consistency with the most recent full assessment (Monnohan et al., 2020), the projection model was parameterized using mean recruitment and stock spawning biomass for all years included in the assessment model (1964 onwards). Future full assessments for BS/AI Flathead sole can consider updating these inputs in light of the Oct 4, 1999 memorandum by R. Marasco indicating that projections of future stock states should be based on year classes 1977 and forward. Changing the projection inputs will affect the scale of the projected biomass, and result in discontinuities between assessment cycles.

## Summary of Results

Based on the updated projection model results, the recommended ABCs for `r nextyr` and `r proj_years[2]` are listed in the table below; the new ABC recommendation and OFL for both `r nextyr` and `r proj_years[2]` are both slightly higher than those projected during the last full assessment (`r lastyr`).

```{r safe, echo = F}
safe = read.csv(here('tables','safe_table.csv'))
names(safe) <- c("",thisyr,nextyr, nextyr, paste(proj_years[2]))
safe[is.na(safe)] <- "n/a"
kableExtra::kable(safe, format.args = list(big.mark = ','), digits = 2, row.names = FALSE,
                  caption = paste0("*Projections  are based on estimated catches of ", 
                                   format(cproj$catch[cproj$year == nextyr], big.mark = ","),
                                   "t used in place of maximum permissible ABC for ",
                                   thisyr," and ",
                                    format(cproj$catch[cproj$year == proj_years[1]], big.mark = ","),
                                   " t used in place of maximum permissible ABC for ",proj_range,
                                                                                             ". The final catch for ",
                                                                                             thisyr,
                                                                                             " was estimated by taking the average tons caught between ",paste0(month(date_pull, label = T), " ",day(date_pull))," and December 31 over the previous 5 years (",paste(range(thisyr-5,lastyr),collapse='-')," and adding this average amount to the catch-to-date as of ", date_pull_long,". The ",nextyr," and ", proj_years[2], " catch was estimated as the average of the total catch in each of the last 5 years.")) %>%
  kableExtra::kable_styling("striped")
                  
```

\newpage

# Tables

::: panel-tabset
## Catch by Spp.

```{r t1, echo = FALSE}
table1 <-  read.csv(here('tables',paste0(date_use,'-catch_proportions.csv'))) 
names(table1) <- c('Year',paste0('Total ',spp[3]), spp[1],spp[4])
table1$Year <- as.character(table1$Year)
kableExtra::kable(table1, format.args = list(big.mark = ','), digits = 2,
                  caption = paste0("Table 1. Catch (in tons) of flathead sole and Bering flounder combined ", spp[2]," and ", spp[1]," only, and ", spp[3]," only in the BSAI as of ",date_pull_long," Observer data on species-specific extrapolated weight in each haul was summed over hauls within each year and used to calculate the proportion of the total Hippoglossoides spp. catch that was flathead sole or Bering flounder. Proportions were multiplied by the total Hippoglossoides spp. (flathead sole and Bering flounder combined) catches reported by AKFIN to obtain total catch of flathead sole separately from that of Bering flounder. 2022 catches are current as of ",date_pull_long," and do not include projections through the end of the year.")) %>%
  kableExtra::kable_styling("striped", font_size = 9)
```

## Survey Biomass and CV (EBS/AI)

```{r t2, echo = FALSE}
table2 <-  read.csv(here('tables',paste0(date_use,'-survey_by_spp.csv'))) 
table2[table2 > 1& !is.na(table2)] <- round(table2[table2 > 1 & !is.na(table2)],0) ## remove decimals on large numbers
table2[table2 < 1& !is.na(table2)] <- round(table2[table2 < 1& !is.na(table2)],2) ## remove excess decimals on small numbers

table2[is.na(table2)] <-""
table2$year <- as.character(table2$year)
names(table2) <- c('Year','Total', 
                   'CV (Total)',
                  'Biomass (AI)',
                  'CV (AI)',
                  'Biomass (EBS, all)',
                  'CV (EBS, all)',
                 'Biomass (EBS, flathead)',
                  'CV (EBS, flathead)',
                    'Biomass (EBS, Bering Flounder)',
                    'CV (EBS, Bering Flounder)')
kableExtra::kable(table2, format.args = list(big.mark = ','), digits = 2,
                  caption = paste0("Table 2. Survey biomass in tons and coefficient of variation (CV) of Hippoglossoides spp. combined (flathead sole and Bering flounder) across the entire BSAI; flathead sole only in the Aleutian Islands, Hippoglossoides spp. combined in the Eastern Bering Sea (EBS) shelf survey, flathead sole only in EBS shelf survey, and Bering flounder only in the EBS shelf survey. Slight discrepancies in totals may occur due to rounding. Bolded years are not included in base model.'Data accessed via Oracle database query on ",date_use_long,".")) %>%
  kableExtra::kable_styling("striped", font_size = 9)
```

## Survey biomass and CV (NBS)

```{r t3, echo = FALSE}
table3 <- read.csv(here('tables',paste0(date_use,'-NBS_survey_by_spp.csv'))) 

table3[table3 > 1& !is.na(table3)] <- round(table3[table3 > 1 & !is.na(table3)],0) ## remove decimals on large numbers
table3[table3 < 1& !is.na(table3)] <- round(table3[table3 < 1& !is.na(table3)],2) ## remove excess decimals on small numbers


table3[is.na(table3)] <-""
table3$year <- as.character(table3$year)
names(table3) <- c('Year',
                   'Biomass (Total)', 
                   'CV (Total)',
                 'Biomass (NBS, flathead)',
                  'CV (NBS, flathead)',
                    'Biomass (NBS, Bering Flounder)',
                    'CV (NBS, Bering Flounder)')
kableExtra::kable(table3, format.args = list(big.mark = ','), 
                  caption = paste0("Table 3. Northern Bering Sea survey biomass (t) and coefficient of variation (CV) for flathead sole, Bering flounder, and the two combined (Hippoglossoides spp.).  These data are not included in the base model and are presented here for reference only. Data accessed via Oracle database query on ",date_use_long,"."))%>%
  kableExtra::kable_styling("striped", font_size = 9)


```
:::

\newpage

# Figures

::: panel-tabset
## Catch vs. Total Biomass

```{r echo = F, fig.cap="Figure 1. Catch to total biomass ratio using total biomass for age 3+ individuals for flathead sole in the Bering Sea and Aleutian Islands. Dotted grey lines represent observed catches for 2021 and projected catches for 2022-2024, none of which are included in the base model."}
knitr::include_graphics( '2022-10-07-Fig1_catchvsbio.png')
```

## Survey Biomass (EBS/AI)

```{r echo = F, fig.cap="Figure 2. Survey biomass from the EBS shelf and Aleutian Islands surveys for station depths less than or equal to 200 meters. Grey and blue points include true observations. A linear regression was used to estimate a relationship between EBS shelf Hippoglossoides spp. survey biomass estimates and AI survey biomass estimates in years when no AI survey occurred (grey 'x' marks). Grey shading indicates ± 1 standard error. Blue points indicate the observed survey biomass in 2021 and 2022, and are not included in the base assessment model."}
knitr::include_graphics('2022-09-28-index_wCVs.png')
```
Author's note: Changes have been made to the stratum-area table, which affects biomass and abundance estimates for EBS data (all years and species). In late 2022, Duane Stevenson (AFSC) provided the following communication about these changes. A visual comparison of EBS FHS survey values from a 2021 data pull vs. the values shown above indicated that the effect of the strata update was negligible. Future benchmark assessments for this species should update the entire survey time series, for consistency.

*Changes were made in 2021 to the stratum area table, which resulted in small changes to the biomass and abundance estimates for all survey years for all species. The changes that were made achieved the following objectives: The projection was transformed into a standard EPSG format; 200m contour was made contiguous to the BS slope shapefiles; EBS and NBS were made contiguous; The boundary artifact polygon was removed;Shapefiles exclude landmass using the ARDEM dataset (downloaded on 12/29/2017) at 0.0 elevation settings for ARDEM transformation/conversion not recorded. If depth limits are changed to 20m in the future, research into optimal settings is advised. NBS extent excludes station AA-10 which was dropped from sampling beginning in 2017. The southern border of the Chukchi Sea survey extent was altered for contiguity. These changes altered the area of extrapolation for each stratum from 0-1.9%, and increased the overall survey area (EBS + NBS) by 0.01%. Because we want to maintain consistency throughout the data series for trend analysis, these new stratum areas were applied to the entire data series this year.*



:::

# References
Kapur, M.S. 2021. 9. Assessment of the Flathead Sole-Bering flounder Stock in the 
Bering Sea and Aleutian Islands. In Stock Assessment and Fishery Evaluation Report for the Groundfish Resources of the Bering Sea/Aleutian Islands Region. North Pacific Fishery Management Council, P.O. Box 103136, Anchorage, Alaska 99510. Available [here](https://apps-afsc.fisheries.noaa.gov/refm/docs/2021/BSAIflathead.pdf).



Monnahan, C., and Haehn, R. 2020. 9. Assessment of the flathead sole-Bering flounder stock complex in the Bering Sea and Aleutian Islands. In Stock Assessment and Fishery Evaluation Report for the Groundfish Resources of the Bering Sea/Aleutian Islands Region. North Pacific Fishery Management Council, P.O. Box 103136, Anchorage, Alaska 99510. Available [here](https://apps-afsc.fisheries.noaa.gov/refm/docs/2020/BSAIflathead.pdf).


