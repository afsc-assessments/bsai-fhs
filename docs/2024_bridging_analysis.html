<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Maia Kapur maia.kapur@noaa.gov">

<title>2024 BSAI FHS Bridging Analyses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="2024_bridging_analysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="2024_bridging_analysis_files/libs/quarto-html/quarto.js"></script>
<script src="2024_bridging_analysis_files/libs/quarto-html/popper.min.js"></script>
<script src="2024_bridging_analysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="2024_bridging_analysis_files/libs/quarto-html/anchor.min.js"></script>
<link href="2024_bridging_analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="2024_bridging_analysis_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="2024_bridging_analysis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="2024_bridging_analysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="2024_bridging_analysis_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#stock-synthesis-software-update-3.30.22" id="toc-stock-synthesis-software-update-3.30.22" class="nav-link" data-scroll-target="#stock-synthesis-software-update-3.30.22">Stock Synthesis Software Update 3.30.22</a>
  <ul class="collapse">
  <li><a href="#warnings" id="toc-warnings" class="nav-link" data-scroll-target="#warnings">Warnings</a></li>
  <li><a href="#likelihood-components" id="toc-likelihood-components" class="nav-link" data-scroll-target="#likelihood-components">Likelihood Components</a></li>
  </ul></li>
  <li><a href="#data-bridging" id="toc-data-bridging" class="nav-link" data-scroll-target="#data-bridging">Data Bridging</a>
  <ul class="collapse">
  <li><a href="#adding-catches" id="toc-adding-catches" class="nav-link" data-scroll-target="#adding-catches">Adding Catches</a></li>
  <li><a href="#adding-survey-biomass" id="toc-adding-survey-biomass" class="nav-link" data-scroll-target="#adding-survey-biomass">Adding Survey Biomass</a></li>
  <li><a href="#adding-survey-caals" id="toc-adding-survey-caals" class="nav-link" data-scroll-target="#adding-survey-caals">Adding Survey CAALs</a></li>
  <li><a href="#adding-fishery-lengths" id="toc-adding-fishery-lengths" class="nav-link" data-scroll-target="#adding-fishery-lengths">Adding Fishery Lengths</a></li>
  <li><a href="#adding-fishery-ages" id="toc-adding-fishery-ages" class="nav-link" data-scroll-target="#adding-fishery-ages">Adding Fishery Ages</a></li>
  <li><a href="#marginal-survey-ages-lengths-ghosted" id="toc-marginal-survey-ages-lengths-ghosted" class="nav-link" data-scroll-target="#marginal-survey-ages-lengths-ghosted">Marginal Survey Ages &amp; Lengths (ghosted)</a></li>
  </ul></li>
  <li><a href="#bridged-update-model-18.2c-2024" id="toc-bridged-update-model-18.2c-2024" class="nav-link" data-scroll-target="#bridged-update-model-18.2c-2024">Bridged “Update” Model, 18.2c (2024)</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">2024 BSAI FHS Bridging Analyses</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Maia Kapur maia.kapur@noaa.gov </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="overview" class="level1">
<h1>Overview</h1>
<p>This electronic document describes the analyses undertaken to bridge the last “full” assessment of BSAI Flathead Sole (Monnahan, 2020) into the latest Stock Synthesis (SS3) software version, as well as explorations of sequential inclusion of recent data.</p>
<p>The general workflow was as follows:</p>
<ol type="1">
<li><p>The 2020 model, referred to as Model 18.2c (2020), was moved from SS3 version 3.30.16 to the the newest SS3 software version as of December 2023 (3.30.22) downloaded from the <a href="https://github.com/nmfs-ost/ss3-source-code/releases">NOAA Virtual Lab</a>. Comparisons between model derived quantities and likelihoods are provided in this document. The version with the updated software is labeled as 18.2c (2024).</p></li>
<li><p>Bridge the data systematically. The previous model has catches and fishery length comps thru 2020, and everything else thru 2019. There is also mean size-at-age data thru 2016 in this model. We added catches through 2023, with an estimate of 2024 catches, then survey abundance indices, then survey CAALs (marginal survey lengths &amp; ages are ghosted, but included as well), then fishery lengths, then fishery ages. The impact of each of these five steps is documented below.</p></li>
</ol>
</section>
<section id="stock-synthesis-software-update-3.30.22" class="level1">
<h1>Stock Synthesis Software Update 3.30.22</h1>
<section id="warnings" class="level2">
<h2 class="anchored" data-anchor-id="warnings">Warnings</h2>
<p>M18.2c (2020) had generic warnings about the recr_dist method; poor FMSY convergence, and an issue with the final gradient. Only the latter is of concern. M18.2c (2024) threw the same warnings as well as an indication that the initial value for parm 11 was greater than the max (999&gt;5); this is the end logit for the survey selex (forcing it to be asymptotic). I am comfortable with the consistency of these warnings; the gradient is identical between models (0.0015022).</p>
</section>
<section id="likelihood-components" class="level2">
<h2 class="anchored" data-anchor-id="likelihood-components">Likelihood Components</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Spawning Biomass</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Survey Fits</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Recruitment Time Series</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">Unfished Recruitment</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../2024/figs/ss_version_bridge/compare2_spawnbio_uncertainty.png" class="img-fluid figure-img" width="975"></p>
<figcaption class="figure-caption">The spawning biomass trajectory and associated uncertainty are identical between models</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../2024/figs/ss_version_bridge/compare13_indices.png" class="img-fluid figure-img" width="975"></p>
<figcaption class="figure-caption">Survey fits are identical between models</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../2024/figs/ss_version_bridge/compare10_recruits_uncertainty.png" class="img-fluid figure-img" width="975"></p>
<figcaption class="figure-caption">The recruitment time series and associated uncertainty are identical between models</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../2024/figs/ss_version_bridge/compare16_densities_SR_LN(R0).png" class="img-fluid figure-img" width="975"></p>
<figcaption class="figure-caption">The R0 posteriors are identical between models</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Based on the above explorations, I am comfortable that moving to the latest SS3 version is not impacting model behavior. After completing this exercise, I addressed the <code>warnings</code> in the latest model via the following. The warning-free model is in <code>model_runs/18.2c_2020_ss3v33022w</code>. + Change <code>recr_dist_method</code> to 4 (line 17) and removing associated stuff lines 99-101 + Change the <code>INIT</code> for Age_DblN_end_logit_Survey to 20 and the MAX to 25 to get rid of the bound error. The selectivity is the same.</p>
</section>
</section>
<section id="data-bridging" class="level1">
<h1>Data Bridging</h1>
<p>This section of the script assumes that one has already downloaded the data; to avoid separate scripts doing the same thing, I’m completing that step in <code>R/2024_analysis.R</code>. Importantly, the data updates conducted here are holistic, meaning that the entire time series of data for each component (where available) is replaced with what is currently available in the AKFIN database. A comparison of each data source is provided below. The model that includes each change is named in the relevant header; these are hosted under <code>model_runs/</code>.</p>
<section id="adding-catches" class="level2">
<h2 class="anchored" data-anchor-id="adding-catches">Adding Catches</h2>
</section>
<section id="adding-survey-biomass" class="level2">
<h2 class="anchored" data-anchor-id="adding-survey-biomass">Adding Survey Biomass</h2>
</section>
<section id="adding-survey-caals" class="level2">
<h2 class="anchored" data-anchor-id="adding-survey-caals">Adding Survey CAALs</h2>
</section>
<section id="adding-fishery-lengths" class="level2">
<h2 class="anchored" data-anchor-id="adding-fishery-lengths">Adding Fishery Lengths</h2>
</section>
<section id="adding-fishery-ages" class="level2">
<h2 class="anchored" data-anchor-id="adding-fishery-ages">Adding Fishery Ages</h2>
</section>
<section id="marginal-survey-ages-lengths-ghosted" class="level2">
<h2 class="anchored" data-anchor-id="marginal-survey-ages-lengths-ghosted">Marginal Survey Ages &amp; Lengths (ghosted)</h2>
</section>
</section>
<section id="bridged-update-model-18.2c-2024" class="level1">
<h1>Bridged “Update” Model, 18.2c (2024)</h1>
<p>This is model 18.2c (2024) and represents an “operational update”; the model structure has not been modified, and only the input data have been revised to reflect the current database. Additional explorations with this model including changes to the</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>