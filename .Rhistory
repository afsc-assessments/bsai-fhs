group_by(year,sex) %>%
dplyr::summarise(Nsamp = n())
inputN_length <- tmp %>%
group_by(year,length_bin_use) %>%
dplyr::summarise(Nsamp = n())
caal0 <- tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n()) %>%
ungroup()%>%
left_join(., inputN_length, by = c('year','length_bin_use')) %>%
# mutate(freq = n_combo/Nsamp) %>%
tidyr::pivot_wider(names_from = age, values_from = n_combo, values_fill = 0, names_expand = TRUE)
sum(is.na(caal0))
call0
inputN_length
sum(is.na(inputN_length))
inputN_length
View(inputN_length)
sum(is.na(tmp))
summary(tmp$age)
summary(tmp$length/10)
tmp <- read.csv(here::here(year, 'data','raw','bsai_ts_length_specimen_data.csv'))  %>%
filter(sex != 3 & !is.na(age) & !is.na(length) & age > 0 & age<plus_age, species_code == 10130) %>%
mutate(
# sex = ifelse(sex == 1,2,1),  ## SS sex is inverse of this dataset
length_grp = cut(round(length/10,0) ,
breaks = seq(10,54,2),
right = FALSE,
labels = FALSE),
length_bin_use = seq(10,54,2)[length_grp])
tmp$length_bin_use[tmp$length_bin_use>52] <- 52 ## avoid NAs
inputN_total <- tmp %>%
group_by(year,sex) %>%
dplyr::summarise(Nsamp = n())
inputN_total <- tmp %>%
group_by(year,sex) %>%
dplyr::summarise(Nsamp = n())
inputN_length <- tmp %>%
group_by(year,length_bin_use) %>%
dplyr::summarise(Nsamp = n())
caal0 <- tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n()) %>%
ungroup()%>%
left_join(., inputN_length, by = c('year','length_bin_use')) %>%
# mutate(freq = n_combo/Nsamp) %>%
tidyr::pivot_wider(names_from = age, values_from = n_combo, values_fill = 0, names_expand = TRUE)
sum(is.na(caal0))
View(caal0)
sum(is.na(tmp))
sum(is.na(inputN_total))
sum(is.na(inputN_length))
length_bin_use
inputN_length <- tmp %>%
group_by(year,length_bin_use) %>%
dplyr::summarise(Nsamp = n())
inputN_length
View(inputN_length)
tmp <- read.csv(here::here(year, 'data','raw','bsai_ts_length_specimen_data.csv'))  %>%
filter(sex != 3 & !is.na(age) & !is.na(length) & age > 0 & age<plus_age, species_code == 10130) %>%
mutate(
# sex = ifelse(sex == 1,2,1),  ## SS sex is inverse of this dataset
length_grp = cut(round(length/10,0) ,
breaks = seq(10,54,2),
right = FALSE,
labels = FALSE),
length_bin_use = seq(10,54,2)[length_grp])
sum(is.na(tmp$length_bin_use))
summary(tmp$length_grp)
tmp <- read.csv(here::here(year, 'data','raw','bsai_ts_length_specimen_data.csv'))  %>%
filter(sex != 3 & !is.na(age) & !is.na(length) & age > 0 & age<plus_age, species_code == 10130) %>%
mutate(
# sex = ifelse(sex == 1,2,1),  ## SS sex is inverse of this dataset
length_grp = cut(round(length/10,0) ,
breaks = seq(0,60,2),
right = FALSE,
labels = FALSE),
length_bin_use = seq(0,60,2)[length_grp])
sum(is.na(tmp$length_grp))
tmp <- read.csv(here::here(year, 'data','raw','bsai_ts_length_specimen_data.csv'))  %>%
filter(sex != 3 & !is.na(age) & !is.na(length) & age > 0 & age<plus_age, species_code == 10130) %>%
mutate(
# sex = ifelse(sex == 1,2,1),  ## SS sex is inverse of this dataset
length_grp = cut(round(length/10,0) ,
breaks = seq(0,60,2),
right = FALSE,
labels = FALSE),
length_bin_use = seq(0,60,2)[length_grp])
tmp$length_bin_use[tmp$length_bin_use<=10] <- 10 ## avoid NAs
tmp$length_bin_use[tmp$length_bin_use>=52] <- 52 ## avoid NAs
inputN_total <- tmp %>%
group_by(year,sex) %>%
dplyr::summarise(Nsamp = n())
inputN_length <- tmp %>%
group_by(year,length_bin_use) %>%
dplyr::summarise(Nsamp = n())
caal0 <- tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n()) %>%
ungroup()%>%
left_join(., inputN_length, by = c('year','length_bin_use')) %>%
# mutate(freq = n_combo/Nsamp) %>%
tidyr::pivot_wider(names_from = age, values_from = n_combo, values_fill = 0, names_expand = TRUE)
sum(is.na(caal0))
caal0 %>%
filter(sex == 1) %>%
merge(., caal0 %>%
filter(sex == 2) %>%
select(-sex, -Nsamp),
by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr)) %>%
arrange(year) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 0, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
max(tmp$year)
Vies(subset(tmp, year > 2019))
View(subset(tmp, year > 2019))
tail(inputN_length)
unique(caal0$year)
caal0 %>%
filter(sex == 1) %>%
merge(., caal0 %>%
filter(sex == 2) %>%
select(-sex, -Nsamp),
by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
arrange(year) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 0, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
caal0 %>%
filter(sex == 1) %>%
merge(., caal0 %>%
filter(sex == 2) %>%
select(-sex, -Nsamp),
by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
arrange(year) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 0, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
age
unique(tmp$age)
?  tidyr::pivot_wider
tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n())
ages
ages[2:20]
left_join(tmp, age = expand.grid(ages[2:22]))
expand.grid(ages[2:22])
head(tmp)
tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
age = 1:plus_age), tmp)
tidytable::left_join(expand.grid(sex = unique(tmp$sex),
year = unique(tmp$year),
age = 1:plus_age), tmp)
caal0 <- tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n()) %>%
ungroup()%>%
left_join(., inputN_length, by = c('year','length_bin_use')) %>%
tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
age = 1:plus_age), .) %>%
# mutate(freq = n_combo/Nsamp) %>%
tidyr::pivot_wider(names_from = age, values_from = n_combo, values_fill = 0, names_expand = TRUE)
summary(caal0)
tmp <- read.csv(here::here(year, 'data','raw','bsai_ts_length_specimen_data.csv'))  %>%
filter(sex != 3 & !is.na(age) & !is.na(length) & age > 0 & age<plus_age, species_code == 10130) %>%
mutate(
# sex = ifelse(sex == 1,2,1),  ## SS sex is inverse of this dataset
length_grp = cut(round(length/10,0) ,
breaks = seq(0,60,2),
right = FALSE,
labels = FALSE),
length_bin_use = seq(0,60,2)[length_grp])
tmp$length_bin_use[tmp$length_bin_use<=10] <- 10 ## avoid NAs
tmp$length_bin_use[tmp$length_bin_use>=52] <- 52 ## avoid NAs
sum(is.na(tmp))
inputN_total <- tmp %>%
group_by(year,sex) %>%
dplyr::summarise(Nsamp = n())
inputN_length <- tmp %>%
group_by(year,length_bin_use) %>%
dplyr::summarise(Nsamp = n())
caal0 <- tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n()) %>%
ungroup()%>%
left_join(., inputN_length, by = c('year','length_bin_use')) %>%
tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
age = 1:plus_age), .) %>%
# mutate(freq = n_combo/Nsamp) %>%
tidyr::pivot_wider(names_from = age, values_from = n_combo, values_fill = 0, names_expand = TRUE)
summary(caal0)
View(caal0)
caal0 %>%
filter(sex == 1) %>%
merge(., caal0 %>%
filter(sex == 2) %>%
select(-sex, -Nsamp),
by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 0, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
sum(is.na(caal0 %>%
filter(sex == 1) %>%
merge(., caal0 %>%
filter(sex == 2) %>%
select(-sex, -Nsamp),
by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 0, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)))
caal0 %>%
filter(sex == 1) %>%
merge(., caal0 %>%
filter(sex == 2) %>%
select(-sex, -Nsamp),
by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 0, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
caal0 %>%
filter(sex == 1) %>%
merge(., caal0 %>%
filter(sex == 2) %>%
select(-sex, -Nsamp),
by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
mod_2020_new_srv_caal <- SS_output(here(year, 'model_runs','18.2c_2020_ss3v33022w-new_srv_caal'))
compsummary_3 <- SSsummarize(list(mod_2020,mod_2020_new_srv_caal))
SSplotComps(mod_2020, kind = 'AGE',fleets=1, subplots = 3, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020, kind = 'AGE',fleets=1, subplots = 3, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
?SSplotComps
SSplotComps(mod_2020,fleets=1, subplots = 3, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020,fleets=2, subplots = 3, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020,fleets=2, subplots = 3, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020,fleets=2, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotData(mod_2020)
SSplotComps(mod_2020)
SSplotComps(mod_2020_new_srv_caal,fleets=2, kind = 'AGE', subplots = 1, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020_new_srv_caal,fleets=2)
SSplotComps(mod_2020_new_srv_caal,fleets=2, kind = 'cond', subplots = 1, datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020_new_srv_caal,fleets=2, kind = 'cond',datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020_new_srv_caal,fleets=2, subplots = 3, kind = 'cond',datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020_new_srv_caal,fleets=2, subplots = 3, kind = 'cond', fixdims = TRUE
datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020_new_srv_caal,fleets=2, subplots = 3, kind = 'cond', fixdims = TRUE,
datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020,fleets=2, subplots = 3, kind = 'cond', fixdims = TRUE,
datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotComps(mod_2020_new_srv_caal,fleets=2
)
SSplotComps(mod_2020_new_srv_caal,fleets=2, kind ='cond')
dev.off()
SSplotComps(mod_2020_new_srv_caal,fleets=2, kind ='cond')
mod_2020_new_srv_caal$condbase
unique(mod_2020_new_srv_caal$condbase$sex)
dim(mod_2020_new_srv_caal$condbase)
dim(mod_2020$condbase)
mod_2020_new_srv_caal <- SS_output(here(year, 'model_runs','18.2c_2020_ss3v33022w-new_srv_caal'))
compsummary_3 <- SSsummarize(list(mod_2020,mod_2020_new_srv_caal))
SSplotComps(mod_2020_new_srv_caal,fleets=2, subplots = 3, kind = 'cond', fixdims = TRUE,
datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
bind_rows(caal0 %>% filter(sex == 1),
caal0 %>%  filter(sex == 2) )
caal1 <- bind_rows(caal0 %>% filter(sex == 1),
caal0 %>%  filter(sex == 2) )
bind_cols(caal_1, caal1[,5:ncol(caal1)])
bind_cols(caal1, caal1[,5:ncol(caal1)])
bind_cols(caal1, caal1[,5:ncol(caal1)]) %>%
# caal0 %>%
#   filter(sex == 1) %>%
#   merge(., caal0 %>%
#           filter(sex == 2) %>%
#           select(-sex, -Nsamp),
#         by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
bind_cols(caal1, caal1[,5:ncol(caal1)]) %>%
# caal0 %>%
#   filter(sex == 1) %>%
#   merge(., caal0 %>%
#           filter(sex == 2) %>%
#           select(-sex, -Nsamp),
#         by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
caal1[,5:ncol(caal1)]
summary(caal1)
View(caal1)
bind_cols(caal1, caal1[,5:ncol(caal1)]) %>%
# caal0 %>%
#   filter(sex == 1) %>%
#   merge(., caal0 %>%
#           filter(sex == 2) %>%
#           select(-sex, -Nsamp),
#         by = c('year','length_bin_use'), all.y = FALSE) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)  %>% View()
head(caal)
summary(caal0)
by = c('year','length_bin_use'), all.y = FALSE) %>%
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Gender = 1, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>% View()
head(caal0)
unique(caal0$sex)
tt <-   bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use))
unique(tt$sex)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender=sex, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender=sex, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender=sex, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2,Gender = sex, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender,Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2,Gender = sex, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender,Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
inputN_total
inputN_length <- tmp %>%
group_by(year,sex,length_bin_use) %>%
dplyr::summarise(Nsamp = n())
caal0 <- tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n()) %>%
ungroup()%>%
left_join(., inputN_length, by = c('year','length_bin_use')) %>%
tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
age = 1:plus_age), .) %>%
# mutate(freq = n_combo/Nsamp) %>%
tidyr::pivot_wider(names_from = age, values_from = n_combo, values_fill = 0, names_expand = TRUE)
caal0 <- tmp %>%
group_by(year, sex, age, length_bin_use) %>%
summarise(n_combo = n()) %>%
ungroup()%>%
left_join(., inputN_length, by = c('year','sex','length_bin_use')) %>%
tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
age = 1:plus_age), .) %>%
# mutate(freq = n_combo/Nsamp) %>%
tidyr::pivot_wider(names_from = age, values_from = n_combo, values_fill = 0, names_expand = TRUE)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2,Gender = sex, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender,Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2,Gender = sex, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender,Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%filter(year == 1982 & Lbin_lo == 10)
bind_cols(caal0, caal0[,5:ncol(caal0)]) %>%
filter(year %in%  unique(mod_2020$condbase$Yr) | year > 2019) %>%
filter(!is.na(length_bin_use)) %>%
arrange(year,sex) %>%
mutate(Seas = 7, FltSvy = 2,Gender = sex, Part = 0, Ageerr = 1, Lbin_lo = length_bin_use,
Lbin_hi = length_bin_use) %>%
select(year, Seas, FltSvy, Gender,Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, everything(),
-length_bin_use,-sex) %>%
write.csv(., file = here::here(year,'data','output','srv_caal_ss3.csv'), row.names = FALSE)
mod_2020_new_srv_caal <- SS_output(here(year, 'model_runs','18.2c_2020_ss3v33022w-new_srv_caal'))
compsummary_3 <- SSsummarize(list(mod_2020,mod_2020_new_srv_caal))
SSplotComps(mod_2020_new_srv_caal,fleets=2, subplots = 3, kind = 'cond',
datonly = TRUE, maxrows = 6,showsampsize = TRUE, showeffN = FALSE)
SSplotBiology(mod_2020)
SSplotBiology(mod_2020,subplots = 1)
par(mfrow = c(1,2))
SSplotBiology(mod_2020,subplots = 1)
SSplotBiology(mod_2020_new_srv_caal,subplots = 1)
SSplotComparisons(compsummary_3,
legendlabels = c('Model 18.2c (2020)','Model 18.2c (2020) with new CAAL data'),
subplots = 13)
SSplotComparisons(compsummary_3,
legendlabels = c('Model 18.2c (2020)','Model 18.2c (2020) with new CAAL data'),
subplots = 12)
SSplotComparisons(compsummary_3,
legendlabels = c('Model 18.2c (2020)','Model 18.2c (2020) with new CAAL data'),
subplots = 2)
## note that I changed the "collected" column so that only the difference between collected & aged is peeking out
otodat <- read.csv(here::here(year,'data','user_input','otolith_reads_vs_aged.csv')) %>%
mutate(Collected_plot = Collected-Aged,
proportion = ifelse(Aged ==0 |is.na(Collected),'',round(Aged/Collected,2))) %>%
select(-region, -effN_mod2020,-Collected) %>%
reshape2::melt(id = c('Year','source', 'proportion')) %>%
mutate(variable = forcats::fct_relevel(variable, c('Collected_plot','Aged')))
ggplot(otodat, aes(x = Year, y = value, fill = variable, color = variable )) +
geom_bar(position = 'stack', stat = 'identity', width = 1) +
labs(x = 'Year', y = 'Number of Otoliths', fill = '', color = '') +
scale_color_manual(values = c('grey77','dodgerblue2'), labels = c('Collected','Aged'))+
scale_fill_manual(values = c('grey77','dodgerblue2'), labels = c('Collected','Aged'))+
scale_x_continuous(expand = c(0,0))+
facet_grid(source~.)+
geom_bar(data = subset(otodat, Year>2021 & variable == 'Aged'),position = 'stack', stat = 'identity', width = 1, fill = 'red', color = 'red')
with(mod_2020$condbase, max$length)
head(mod_2020$condbase)
with(mod_2020$condbase, max$Lbin_lo)
with(mod_2020$condbase, max(Lbin_lo)
)
with(mod_2020_new_srv_caal$condbase, max(Lbin_lo))
