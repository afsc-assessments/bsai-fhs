theme_set(afscassess::theme_report())
## This worked for MK in VSCode:
# options(buildtools.check = function(action) TRUE )
# devtools::install_github("afsc-assessments/rema") ## did not update other pckgs
# pak::pkg_install("afsc-assessments/rema")
library(rema)
# globals ----
year = 2024
rec_age = 0 ## this is default for SS3
plus_age = 21
lengths = c(seq(6,40,2),seq(43,58,3))
TAC = c(25000, 25000, 35500) # 2021, 2022, 2023
species = "FSOL"
#curr_mdl_fldr = "2020.1-2023"
#prev_mdl_fldr = "2020.1-2021"
#mdl_name = "model_20_1"
#dat_name = "goa_pop"
area = "BSAI"
species = "FSOL"
afsc_species = 10130
norpac_species = c(103,145)
add_fields='sex'
db=akfin=connect()
# globals ----
year = 2024
rec_age = 0 ## this is default for SS3
plus_age = 21
lengths = c(seq(6,40,2),seq(43,58,3))
TAC = c(25000, 25000, 35500) # 2021, 2022, 2023
species = "FSOL"
#curr_mdl_fldr = "2020.1-2023"
#prev_mdl_fldr = "2020.1-2021"
#mdl_name = "model_20_1"
#dat_name = "goa_pop"
area = "BSAI"
species = "FSOL"
afsc_species = 10130
norpac_species = c(103,145)
add_fields='sex'
akfin=connect()
afsc=connect('afsc')
yr = year
area = toupper(area)
aa <- dplyr::tbl(db, dplyr::sql("racebase.cruise")) %>%
dplyr::rename_with(tolower)
bb <- dplyr::tbl(db, dplyr::sql("racebase.haul")) %>% dplyr::rename_with(tolower)
cc <- dplyr::tbl(db, dplyr::sql("racebase.specimen")) %>%
dplyr::rename_with(tolower)
db=afsc
yr = year
area = toupper(area)
aa <- dplyr::tbl(db, dplyr::sql("racebase.cruise")) %>%
dplyr::rename_with(tolower)
bb <- dplyr::tbl(db, dplyr::sql("racebase.haul")) %>% dplyr::rename_with(tolower)
cc <- dplyr::tbl(db, dplyr::sql("racebase.specimen")) %>%
dplyr::rename_with(tolower)
cc
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date) %>% dplyr::filter(abundance_haul ==
"Y", year <= yr, region %in% area, species_code %in%
species) %>% dplyr::arrange(year)
dim(table)
table
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature))
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity))
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date)
area
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date)
unique(table$region)
View(table)
species
species = 10130
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date) %>% dplyr::filter(abundance_haul ==
"Y", year <= yr, region %in% area, species_code %in%
species) %>% dplyr::arrange(year)
head(table)
area
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date)
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date) %>% View()
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date) %>% data.frame() %>%View()
db
afsc
db = afsc
area
species
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date)
dim(table)
with(table, plot(end_latitude, end_longitude))
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date) %>% dplyr::filter(abundance_haul ==
"Y", year <= yr, region %in% area, species_code %in%
species) %>% dplyr::arrange(year)
head(table)
View(table)
View(data.fram(table))
View(data.frame(table))
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date)
View(data.frame(table))
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date) %>% dplyr::filter(abundance_haul ==
"Y", year <= yr, region %in% area
)
head(table)
table <- dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date)) %>%
dplyr::select(-start_date) %>% dplyr::filter(abundance_haul ==
"Y", year <= yr,
species_code %in%
species)
head(table)
View(q_bts_biomass)
View(q_bts_length)
aa
aa <- dplyr::tbl(db, dplyr::sql("racebase.cruise")) %>%
dplyr::rename_with(tolower)
bb <- dplyr::tbl(db, dplyr::sql("racebase.haul")) %>% dplyr::rename_with(tolower)
cc <- dplyr::tbl(db, dplyr::sql("racebase.specimen")) %>%
dplyr::rename_with(tolower)
cc
bb
unique(bb$region)
summary(bb)
summary(data.frame(bb))
aa
region
dplyr::select(aa, cruisejoin, region, survey_name,
start_date)
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature))
dplyr::select(aa, cruisejoin, region, survey_name,
start_date) %>% dplyr::left_join(dplyr::select(bb, cruisejoin,
hauljoin, end_latitude, end_longitude, bottom_depth,
abundance_haul, stratum, gear_temperature)) %>% dplyr::left_join(dplyr::select(cc,
hauljoin, species_code, sex, length, weight, age, maturity)) %>%
dplyr::mutate(year = lubridate::year(start_date))
aa
bb
cc
unique(cc$region)
class(cc$region)
View(cc$region)
View(data.frame(cc$reg''))
View(data.frame(cc$region))
db_list_tables(afsc)
dplyr::sql
db
DBI::dbListTables(afsc)
DBI::dbListTables(akfin)
dplyr::tbl(db, dplyr::sql("racebase.specimen"))
cc <- dplyr::tbl(db, dplyr::sql("racebase.specimen")) %>%
dplyr::rename_with(tolower)
dd <- as.data.frame(cc)
afscdata::catch_to_ss3
# fishery age comp, by sex
fac0 <- vroom::vroom(here::here(year, "data", "raw", "fsh_specimen_data.txt"), delim = ",",
col_type = c(join_key = "c",
haul_join = "c", port_join = "c")) %>%
tidytable::filter(age >= rec_age,
!is.na(length),
!is.na(sex),
sex != 'U',
!is.na(performance)) %>%
tidytable::mutate(age = ifelse(age > plus_age, plus_age,
age)) %>%
tidytable::mutate(tot = tidytable::n(),   .by = year) %>%
# tidytable::filter(tot > 49) %>%
tidytable::mutate(n_h = length(unique(na.omit(haul_join))) + length(unique(na.omit(port_join))), .by = year) %>%
tidytable::summarise(n_s = mean(tot),
n_h = mean(n_h),
age_tot = tidytable::n(), .by = c(sex,year,age)) %>%
tidytable::mutate(prop = age_tot/n_s) %>%
tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
age = 1:plus_age), .) %>%
tidytable::replace_na(list(prop = 0)) %>%
tidytable::mutate(AA_Index = 1, n_s = mean(n_s, na.rm = T),
n_h = mean(n_h, na.rm = T), .by = year) %>%
tidytable::select(-age_tot) %>%
tidytable::pivot_wider(names_from = age, values_from = prop)
fac %>% filter(sex == 'F') %>%
merge(., fac %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h, - AA_Index),
by = 'year', all.y = FALSE) %>%
arrange(year) %>%
## drop the years before 2000 since Lcomps are available
mutate(Seas = 7, FltSvy = ifelse(year < 2000, -1, 1), Gender = 3,
Part = 0, Ageerr = 1, LbinLo = -1, LbinHi = -1, Nsamp = n_h) %>%
select(Yr = year, Seas, FltSvy, Gender, Part, Ageerr, LbinLo, LbinHi, Nsamp, everything(), -sex, -n_s, -n_h, -AA_Index) %>%
write.csv(., file = here::here(year,'data','output','fsh_age_comp_ss3.csv'), row.names = FALSE)
AFSC = afsc
AKFIN =akfin
#* survey size composition data -----
message("Querying sizecomp EBS survey hauls...")
query <- "
select * from haehnr.samplesize_ebs_standard
where species_code = 10130
order by year;
"
test <- sqlQuery(AFSC, query)
if(!is.data.frame(test)) stop("Query failed")
sqlQuery
#* Packages & Oracle ----
require(RODBC)
require(dplyr)
require(here)
require(ggplot2)
require(r4ss)
library(tidyverse)
require(rstudioapi) ## enables masking of RODBC name, password
test <- sqlQuery(AFSC, query)
username_AFSC <- showPrompt(title="Username", message="Enter your AFSC username:", default="")
password_AFSC <- askForPassword(prompt="Enter your AFSC password:")
AFSC <- odbcConnect("AFSC",username_AFSC,password_AFSC,  believeNRows = FALSE)
username_AKFIN <- showPrompt(title="Username", message="Enter your AKFIN username:", default="")
password_AKFIN <- askForPassword(prompt="Enter your AKFIN password:")
AKFIN <- odbcConnect("AKFIN",username_AKFIN,password_AKFIN,  believeNRows = FALSE)
#* Query spex ----
final_year <- 2024
fsh_sp_area <- "'BS','AI'"              # FMP
fsh_sp_label <- "'FSOL'"                # AKFIN group species label
fsh_sp_str <- "103"                     # AKFIN species code
fsh_start_yr <- 1977                    # start year
sp_area <- "'BS'"                       #
## length bins to use for fsh and srv length comp data
max_size <- max(mod_2020$lbins) ##65 = rex ##70 = Dover and Flathead
min_size <- min(mod_2020$lbins)
bin_width <- 2
len_bins <- mod_2020$lbins#c(seq(min_size,max_size,bin_width),43,46,49,52,55,58)
lapply(list.files(here('2023','sql'), full.names = T), source) ## load all sql queries
query <- "
select * from haehnr.samplesize_ebs_standard
where species_code = 10130
order by year;
"
test <- sqlQuery(AFSC, query)
if(!is.data.frame(test)) stop("Query failed")
test
query
query <- "
select * from haehnr.samplesize_ebs_standard
order by year;
"
test <- sqlQuery(AFSC, query)
test
afscassess::fish_age_comp
afscassess::bts_age_comp
vroom::vroom(here::here(year, "data", "raw", "fsh_specimen_data.txt"), delim = ",",
col_type = c(join_key = "c",
haul_join = "c", port_join = "c"))
fac0 <- vroom::vroom(here::here(year, "data", "raw", "fsh_specimen_data.txt"), delim = ",",
col_type = c(join_key = "c",
haul_join = "c", port_join = "c"))
unique(fac0$species)
# fishery size comp
afscassess::fish_length_comp(year = year,
rec_age = rec_age,
lenbins = lengths)
afscassess::fish_length_comp
View(afscassess::fish_length_comp)
ages <- vroom::vroom(here::here(year, "data", "raw", paste0(fishery,
"_specimen_data.txt")), delim = ",", col_type = c(join_key = "c",
haul_join = "c", port_join = "c")) %>% tidytable::filter(!is.na(age),
age >= rec_age) %>% tidytable::group_by(year) %>% tidytable::tally(name = "age") %>%
tidytable::filter(age >= 50) %>% tidytable::ungroup()
ages <- vroom::vroom(here::here(year, "data", "raw", "fhs_specimen_data.txt"), delim = ",", col_type = c(join_key = "c",
haul_join = "c", port_join = "c")) %>% tidytable::filter(!is.na(age),
age >= rec_age) %>% tidytable::group_by(year) %>% tidytable::tally(name = "age") %>%
tidytable::filter(age >= 50) %>% tidytable::ungroup()
year
- vroom::vroom(here::here(year, "data", "raw", "fhs_specimen_data.txt")
vroom::vroom(here::here(year, "data", "raw", "fhs_specimen_data.txt")
vroom::vroom(here::here(year, "data", "raw", "fhs_specimen_data.txt")
vroom::vroom(here::here(year, "data", "raw", "fhs_specimen_data.txt"), delim = ",", col_type = c(join_key = "c",
here::here(year, "data", "raw", "fhs_specimen_data.txt")
ages <- vroom::vroom(here::here(year, "data", "raw", "fsh_specimen_data.txt"), delim = ",", col_type = c(join_key = "c",
haul_join = "c", port_join = "c")) %>% tidytable::filter(!is.na(age),
age >= rec_age) %>% tidytable::group_by(year) %>% tidytable::tally(name = "age") %>%
tidytable::filter(age >= 50) %>% tidytable::ungroup()
ages
flc <- vroom::vroom(here::here(year, "data", "raw", "fsh_length_data.txt"), delim = ",", col_type = c(haul_join = "c",
port_join = "c")) %>% tidytable::filter(!(year %in%
unique(ages$year))) %>% tidytable::mutate(tot = sum(frequency),
length = ifelse(length >= max(lenbins), max(lenbins),
length), n_h = length(unique(na.omit(haul_join))) +
length(unique(na.omit(port_join))), .by = year) %>%
tidytable::summarise(n_s = mean(tot), n_h = mean(n_h),
length_tot = sum(frequency), .by = c(year, length)) %>%
tidytable::mutate(prop = length_tot/n_s) %>% tidytable::left_join(expand.grid(year = unique(.$year),
length = lenbins), .) %>% tidytable::replace_na(list(prop = 0)) %>%
tidytable::mutate(SA_Index = 1, n_s = mean(n_s, na.rm = T),
n_h = mean(n_h, na.rm = T), .by = year) %>% tidytable::select(-length_tot) %>%
tidytable::pivot_wider(names_from = length, values_from = prop)
lenbins = lengths
flc <- vroom::vroom(here::here(year, "data", "raw", "fsh_length_data.txt"), delim = ",", col_type = c(haul_join = "c",
port_join = "c")) %>% tidytable::filter(!(year %in%
unique(ages$year))) %>% tidytable::mutate(tot = sum(frequency),
length = ifelse(length >= max(lenbins), max(lenbins),
length), n_h = length(unique(na.omit(haul_join))) +
length(unique(na.omit(port_join))), .by = year) %>%
tidytable::summarise(n_s = mean(tot), n_h = mean(n_h),
length_tot = sum(frequency), .by = c(year, length)) %>%
tidytable::mutate(prop = length_tot/n_s) %>% tidytable::left_join(expand.grid(year = unique(.$year),
length = lenbins), .) %>% tidytable::replace_na(list(prop = 0)) %>%
tidytable::mutate(SA_Index = 1, n_s = mean(n_s, na.rm = T),
n_h = mean(n_h, na.rm = T), .by = year) %>% tidytable::select(-length_tot) %>%
tidytable::pivot_wider(names_from = length, values_from = prop)
flc
flc0 <- vroom::vroom(here::here(year, "data", "raw", "fsh_length_data.txt"),
delim = ",",
col_type = c(haul_join = "c",
port_join = "c")) %>% tidytable::filter(!(year %in% unique(ages$year))) %>%
tidytable::mutate(tot = sum(frequency),
length = ifelse(length >= max(lenbins), max(lenbins),
length), n_h = length(unique(na.omit(haul_join))) +
length(unique(na.omit(port_join))), .by = year) %>%
tidytable::summarise(n_s = mean(tot), n_h = mean(n_h),
length_tot = sum(frequency), .by = c(sex,year, length)) %>%
tidytable::mutate(prop = length_tot/n_s) %>% tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
length = lenbins), .) %>% tidytable::replace_na(list(prop = 0)) %>%
tidytable::mutate(SA_Index = 1, n_s = mean(n_s, na.rm = T),
n_h = mean(n_h, na.rm = T), .by = year) %>% tidytable::select(-length_tot) %>%
tidytable::pivot_wider(names_from = length, values_from = prop)
flc0
flc0 %>% filter(sex == 'F') %>%
merge(., fac %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h, - AA_Index),
by = 'year', all.y = FALSE) %>%
arrange(year) %>%
## drop the years before 2000 since Lcomps are available
mutate(Seas = 7, FltSvy = ifelse(year %in% fac0$year & year >= 2000, -1, 1), Gender = 3,
Part = 0, Ageerr = 1, LbinLo = -1, LbinHi = -1, Nsamp = n_h) %>%
select(Yr = year, Seas, FltSvy, Gender, Part, Ageerr, LbinLo, LbinHi, Nsamp, everything(), -sex, -n_s, -n_h, -AA_Index)
flc0 %>% filter(sex == 'F') %>%
merge(., fac %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h, - AA_Index),
by = 'year', all.y = FALSE) %>%
arrange(year)
flc0 <- vroom::vroom(here::here(year, "data", "raw", "fsh_length_data.txt"),
delim = ",",
col_type = c(haul_join = "c",
port_join = "c")) %>% tidytable::filter(!(year %in% unique(ages$year))) %>%
tidytable::mutate(tot = sum(frequency),
length = ifelse(length >= max(lenbins), max(lenbins),
length), n_h = length(unique(na.omit(haul_join))) +
length(unique(na.omit(port_join))), .by = year) %>%
tidytable::summarise(n_s = mean(tot), n_h = mean(n_h),
length_tot = sum(frequency), .by = c(sex,year, length)) %>%
tidytable::mutate(prop = length_tot/n_s) %>% tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
length = lenbins), .) %>% tidytable::replace_na(list(prop = 0)) %>%
tidytable::mutate(SA_Index = 1, n_s = mean(n_s, na.rm = T),
n_h = mean(n_h, na.rm = T), .by = year) %>% tidytable::select(-length_tot) %>%
tidytable::pivot_wider(names_from = length, values_from = prop)
flc0 %>% filter(sex == 'F') %>%
merge(., flc0 %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h, - AA_Index),
by = 'year', all.y = FALSE) %>%
arrange(year)
flc0 %>% filter(sex == 'F') %>%
merge(., flc0 %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h),
by = 'year', all.y = FALSE) %>%
arrange(year)
flc0 %>% filter(sex == 'F') %>%
merge(., flc0 %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h),
by = 'year', all.y = FALSE) %>%
arrange(year) %>%
## drop the years before 2000 since Lcomps are available
mutate(Seas = 7, FltSvy = ifelse(year %in% fac0$year & year >= 2000, -1, 1), Gender = 3,
Part = 0, Ageerr = 1, LbinLo = -1, LbinHi = -1, Nsamp = n_h) %>%
select(Yr = year, Seas, FltSvy, Gender, Part, Ageerr, LbinLo, LbinHi, Nsamp, everything(), -sex, -n_s, -n_h)
flc0 %>% filter(sex == 'F') %>%
merge(., flc0 %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h),
by = 'year', all.y = FALSE) %>%
arrange(year) %>%
## drop the years before 2000 since Lcomps are available
mutate(Seas = 7, FltSvy = ifelse(year %in% fac0$year & year >= 2000, -1, 1), Gender = 3,
Part = 0, Ageerr = 1, LbinLo = -1, LbinHi = -1, Nsamp = n_h)
flc0 %>% filter(sex == 'F') %>%
merge(., flc0 %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h),
by = 'year', all.y = FALSE) %>%
arrange(year) %>%
## drop the years before 2000 since Lcomps are available
mutate(Seas = 7, FltSvy = ifelse(year %in% fac0$year & year >= 2000, -1, 1), Gender = 3,
Part = 0, Ageerr = 1, LbinLo = -1, LbinHi = -1, Nsamp = n_h) %>%
select(Yr = year, Seas, FltSvy, Gender, Part, Ageerr, LbinLo, LbinHi, Nsamp, everything(), -sex, -n_s, -n_h) %>%View()
unique(fac0$year)
flc0 %>% filter(sex == 'F') %>%
merge(., flc0 %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h),
by = 'year', all.y = FALSE) %>%
arrange(year) %>%
## drop the years before 2000 since Lcomps are available
mutate(Seas = 7, FltSvy = ifelse(year %in% unique(fac0$year) & year >= 2000, -1, 1), Gender = 3,
Part = 0, Ageerr = 1, LbinLo = -1, LbinHi = -1, Nsamp = n_h) %>%
select(Yr = year, Seas, FltSvy, Gender, Part, Ageerr, LbinLo, LbinHi, Nsamp, everything(), -sex, -n_s, -n_h) %>%
View()
flc0
unique(flc0$year)
flc0 <- vroom::vroom(here::here(year, "data", "raw", "fsh_length_data.txt"),
delim = ",",
col_type = c(haul_join = "c",
port_join = "c")) %>%
# tidytable::filter(!(year %in% unique(ages$year))) %>%
tidytable::mutate(tot = sum(frequency),
length = ifelse(length >= max(lenbins), max(lenbins),
length), n_h = length(unique(na.omit(haul_join))) +
length(unique(na.omit(port_join))), .by = year) %>%
tidytable::summarise(n_s = mean(tot), n_h = mean(n_h),
length_tot = sum(frequency), .by = c(sex,year, length)) %>%
tidytable::mutate(prop = length_tot/n_s) %>% tidytable::left_join(expand.grid(sex = unique(.$sex),
year = unique(.$year),
length = lenbins), .) %>% tidytable::replace_na(list(prop = 0)) %>%
tidytable::mutate(SA_Index = 1, n_s = mean(n_s, na.rm = T),
n_h = mean(n_h, na.rm = T), .by = year) %>% tidytable::select(-length_tot) %>%
tidytable::pivot_wider(names_from = length, values_from = prop)
flc0
flc0 %>% filter(sex == 'F') %>%
merge(., flc0 %>%
filter(sex == 'M') %>%
select(-sex, -n_s,-n_h),
by = 'year', all.y = FALSE) %>%
arrange(year)
